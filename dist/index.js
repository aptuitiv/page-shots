#! /usr/bin/env node
import{Command as te}from"commander";import se from"fs-extra";import D from"path";import{fileURLToPath as oe}from"url";import V from"fs-extra";import{extname as I}from"path";import c from"chalk";import f from"fancy-log";import T from"log-symbols";var d=(e,i)=>{f(c.cyan(e),i??"")};var p=(e,i)=>{i?f(T.success,c.green(e),c.cyan(i)):f(T.success,c.green(e))};var g=(e,i)=>{f(T.error,c.red(e)),i&&(f(c.red(i.message)),f(c.red(i.stack)))};var E=e=>["n","no",!1,"false"].includes(e),m=e=>["y","yes",!0,"true"].includes(e),b=e=>m(e)||E(e),N=e=>typeof e=="boolean",u=e=>typeof e<"u",A=e=>!Number.isNaN(e)&&typeof e=="number"&&e!==1/0,H=e=>typeof e=="string"&&e.trim().length>0&&!Number.isNaN(Number(e))&&e!=="Infinity",a=e=>A(e)||H(e),j=e=>Object.prototype.toString.call(e)==="[object Object]",y=e=>Object.prototype.toString.call(e)==="[object Object]"&&Object.keys(e).length>0,J=e=>typeof e=="string",o=e=>J(e)&&e.trim().length>0;var U=(e,i)=>j(e)&&i in e;var h=(e,i)=>U(e,i)&&a(e[i]);var z=(e,i)=>U(e,i)&&o(e[i]);var R={baseUrl:"",clip:!1,delay:0,dir:"",fileName:"",fileType:"jpg",fullScreen:!0,height:900,nameFormat:"{url}-{width}",quality:100,sizes:[],urls:[],width:1300},w=3e4,O=e=>{let i=0;if(a(e)){let t=parseInt(e.toString(),10);t>0&&(i=t)}return i},L=e=>{let i=!1;if(o(e)){let t=e.toLowerCase().replace(".","");["jpg","jpeg","png"].includes(t)&&(t==="jpeg"&&(t="jpg"),i=t)}return i},S=class{config;configParam;processFile;processSizes;processUrls;constructor(i){this.config=i??R,this.processFile=!1,this.processSizes=!0,this.processUrls=!0}setProcessConfigFile(){this.processFile=!0}setDoNotProcessSizes(){this.processSizes=!1}setDoNotProcessUrls(){this.processUrls=!1}parse(i){y(i)&&(this.setProcessConfigFile&&o(i?.config)&&this.#o(i.config),this.#t(i))}#o(i){try{let t="shots.json";typeof i=="string"&&i.length>0&&(t=i,I(i).toLowerCase().replace(".","").length===0&&(t+=".json")),V.existsSync(t)?this.#t(V.readJsonSync(t)):g(`The JSON config file "${t}" could not be found`)}catch(t){g(`Error while processing the JSON config file ${i}`,t),process.exit()}}#t(i){this.configParam=i,this.#n(),this.#r(),this.#a(),this.#g(),this.#c(),this.#h(),this.#f(),this.#l(),this.#p(),this.processUrls&&this.#m(),this.processSizes&&this.#u(),this.#y()}getConfig(){return this.config}hasUrls(){return this.config.urls.length>0}#n(){o(this.configParam?.base)?this.config.baseUrl=this.configParam.base:o(this.configParam?.baseUrl)&&(this.config.baseUrl=this.configParam.baseUrl)}#r(){if(y(this.configParam?.clip)){if(h(this.configParam.clip,"x")&&h(this.configParam.clip,"y")&&h(this.configParam.clip,"w")&&h(this.configParam.clip,"h")){let i=parseInt(this.configParam.clip.x.toString(),10),t=parseInt(this.configParam.clip.y.toString(),10),s=parseInt(this.configParam.clip.width.toString(),10),n=parseInt(this.configParam.clip.height.toString(),10);i>=0&&t>=0&&s>0&&n>0&&(this.config.clip={x:i,y:t,width:s,height:n})}}else if(a(this.configParam?.clipWidth)&&a(this.configParam?.clipHeight)){let i=a(this.configParam?.clipX)?this.configParam.clipX:0,t=a(this.configParam?.clipY)?this.configParam.clipY:0,s=parseInt(i.toString(),10),n=parseInt(t.toString(),10),r=parseInt(this.configParam.clipWidth.toString(),10),l=parseInt(this.configParam.clipHeight.toString(),10);s>=0&&n>=0&&r>0&&l>0&&(this.config.clip={x:s,y:n,width:r,height:l})}}#a(){if(a(this.configParam?.delay)){let i=parseInt(this.configParam.delay.toString(),10);i>0&&(i>w&&(i=w),this.config.delay=i)}}#g(){o(this.configParam?.dir)&&(this.config.dir=this.configParam.dir.replace(/\/$/,""))}#c(){if(o(this.configParam?.name))if(this.configParam.name.includes("{"))this.config.nameFormat=this.configParam.name;else{let i=L(I(this.configParam.name));this.config.fileName=this.configParam.name,i&&(this.config.fileType=i)}}#h(){if(o(this.configParam?.type)){let i=L(this.configParam.type);i&&(i==="jpg"&&(i="jpeg"),this.config.fileType=i)}m(this.configParam?.jpg)&&(this.config.fileType="jpeg"),m(this.configParam?.png)&&(this.config.fileType="png")}#f(){let i=!0;b(this.configParam?.fit)?i=this.configParam.fit:b(this.configParam?.fullscreen)?i=this.configParam.fullscreen:b(this.configParam?.full)&&(i=this.configParam.full),m(i)?this.config.fullScreen=!0:this.config.fullScreen=!1}#l(){let i=O(this.configParam?.height);i>0&&(this.config.height=i)}#p(){if(a(this.configParam?.quality)){let i=parseInt(this.configParam.quality.toString(),10);i>0&&i<=100&&(this.config.quality=i)}}#m(){if(Array.isArray(this.configParam?.urls)){this.config.urls=[];for(let i of this.configParam.urls)this.#e(i)}else if(o(this.configParam?.urls))this.#e(this.configParam.urls);else if(Array.isArray(this.configParam?.url)){this.config.urls=[];for(let i of this.configParam.url)this.#e(i)}else o(this.configParam?.url)&&this.#e(this.configParam.url)}#e(i){y(i)&&z(i,"url")?this.config.urls.push(i):o(i)&&this.config.urls.push({url:i})}#u(){u(this.configParam?.sizes)?this.#s(this.configParam.sizes):u(this.configParam?.size)&&this.#s(this.configParam.size)}#s(i){if(o(i))this.#i(i);else if(Array.isArray(i))for(let t of i)this.#i(t);else y(i)&&this.#i(i)}#i(i){if(o(i)){let t=i.split("x");if(t.length===2){let s=parseInt(t[0],10),n=parseInt(t[1],10);s>0&&n>0&&this.config.sizes.push({height:n,width:s})}}else if(h(i,"width")&&h(i,"height")){let t=parseInt(i.width.toString(),10),s=parseInt(i.height.toString(),10);t>0&&s>0&&this.config.sizes.push(i)}}#y(){let i=O(this.configParam?.width);i>0&&(this.config.width=i)}};import{createWriteStream as X}from"fs";import{extname as Y,join as _}from"path";import Q from"chalk";import G from"sanitize-filename";import M from"ora";var K={dir:"",filename:"shots.json",setDir(e){if(typeof e=="string"){let i=e.trim();i.length>1&&(i.substring(i.length-1)!=="/"&&(i=`${i}/`),this.dir=i)}},setFilename(e){let i=Y(e).toLowerCase().replace(".",""),t=e;i!=="json"&&(t+=".json"),t=G(t,{replacement:"-"}),this.filename=t},build(){let e={baseUrl:"",name:"{url}-{width}",type:"jpg",urls:[],sizes:["1300x800"]},i=_(this.dir,this.filename),t=M({text:`Creating ${this.filename}`,spinner:"arc"}).start(),s=X(i,{flags:"w"});s.write(JSON.stringify(e,null,4)),s.close(),t.succeed(Q.green(`${this.filename} created`))}},P=K;import $ from"fs-extra";import{dirname as Z,extname as q,join as ee}from"path";import{Cluster as k}from"puppeteer-cluster";import B from"sanitize-filename";function C(){return process.hrtime.bigint()}function F(e){let i=process.hrtime.bigint(),t=Number(e);return((Number(i)-t)/1e9).toFixed(4)}var ie={config:{},async run(e){this.config=e;try{let i=C(),t=await k.launch({concurrency:k.CONCURRENCY_CONTEXT,maxConcurrency:10});await t.task(async({page:n,data:r})=>{await this.getScreenshot(n,r)});for(let n of this.config.urls){let r=this.setupUrl(n);r.sizes.length>0||t.queue(r)}await t.idle(),await t.close();let s=F(i);d(`Total time to get screenshots: ${s}s`)}catch(i){g("Error getting screenshots",i),process.exit(1)}},async getScreenshot(e,i){let t=C();e.on("load",()=>{let s=F(t);p(`${i.url} loaded in ${s}s`)}),await e.setViewport({width:i.width,height:i.height}),d(`Loading ${i.url}. Viewport size: ${i.width}px / ${i.height}px`),await e.goto(i.url);try{d(`Taking screenshot of ${i.path} (${i.width}px / ${i.height}px)`),await e.screenshot(this.getScreenshotConfig(i)),p(`Saved ${i.path} (${i.width}px / ${i.height}px)`)}catch(s){g("Error while taking the screenshot",s)}},getScreenshotConfig(e){let i={fullPage:e.fullScreen,path:e.path,type:e.type};return e.type==="jpg"&&(i.quality=e.quality,i.type="jpeg"),e.clip&&(i.fullPage=!1,i.clip=e.clip),i},createDir(e){let i=Z(e.path);i.length>0&&!$.existsSync(i)&&$.mkdirSync(i,{recursive:!0})},setupUrl(e){o(e.baseUrl)||(e.baseUrl=this.config.baseUrl),o(e.baseUrl)&&e.url.substring(0,e.baseUrl.length)!==e.baseUrl&&e.url.match(/^http(s?):\/\//)===null&&(e.url.substring(0,1)!=="/"&&(e.url=`/${e.url}`),e.url=e.baseUrl+e.url);let{clip:i}=this.config;u(e.clip)&&(i=e.clip,delete e.clip),i=this.config.processClip(i),i!==!1&&(e.clip=i),e.delay=this.config.processDelay(e?.delay),this.config.delay>e.delay&&(e.delay=this.config.delay),e.dir=this.getDir(e);let t=this.config.processFitAndFullScreen(e);return t===null&&(t=this.config.fullScreen),N(t)&&(e.fullScreen=t),e.height=this.config.processHeightWidth(e?.height),e.height===0&&this.config.height>0&&(e.height=this.config.height),e.type=this.getFileType(e),e.quality=this.config.processQuality(e?.quality),this.config.quality<e.quality&&(e.quality=this.config.quality),e.sizes=this.config.processViewportSizes(e?.sizes),e.sizes.length===0&&this.config.sizes.length>0&&(e.sizes=this.config.sizes),e.width=this.config.processHeightWidth(e?.width),e.width===0&&this.config.width>0&&(e.width=this.config.width),o(e.name)?e.name.search(!0)?(e.filename=this.formatFileName(e,e.name),e.type=this.getFileTypeFromFilename(e)):(e.filename=e.name,e.type=this.getFileTypeFromFilename(e)):(e.filename=this.formatFileName(e,this.config.nameFormat),e.type=this.getFileTypeFromFilename(e)),e.filename=this.getFilename(e),e.path=this.getPath(e),e.type=this.getFileTypeFromFilename(e),e},getDir(e){let i=this.config.processDir(e?.dir);return i.length===0&&this.config.dir.length>0&&(i=this.config.dir),i},getFilename(e){let i="";o(e.name)?e.name.search(!0)?i=this.formatFileName(e,e.name):i=e.name:o(this.config.nameFormat)?i=this.formatFileName(e,this.config.nameFormat):o(this.config.fileName)?i=this.config.fileName:i=this.formatFileName(e,"{url}");let t=q(i).toLowerCase().replace(".","");return o(t)||(t=this.getFileType(e),i+=`.${t}`),i},getPath(e){let i=this.getDir(e),t="";return o(e.filename)?t=e.filename:t=this.getFilename(e),ee(i,t)},getFileType(e,i){let t="";return o(i)?t=this.config.validateFileType(i):t=this.config.validateFileType(e?.type),t||(t=this.config.fileType),t},getFileTypeFromFilename(e){return this.getFileType(e,q(e.filename).toLowerCase().replace(".",""))},formatFileName(e,i){let t=e.url.replace(/http(s?):\/\//,"");t=B(t,{replacement:"-"}),t=t.replace(/\.+/g,"-"),t=t.replace(/-{2,}/g,"-"),t.substring(t.length-1)==="-"&&(t=t.substring(0,t.length-1)),t.substring(0,1)==="-"&&(t=t.substring(1));let s=e.url.replace(/http(s?):\/\//,""),n=s.split("/");s=s.replace(n[0],"").trim(),s==="/"||s.length===0?s="home":(s.substring(0,1)==="/"&&(s=s.substring(1)),s=B(s,{replacement:"-"}),s=s.replace(/\.+/g,"-"),s=s.replace(/-{2,}/g,"-"),s.substring(s.length-1)==="-"&&(s=s.substring(0,s.length-1)),s.substring(0,1)==="-"&&(s=s.substring(1)));let r="full",l="fit";return e.fullScreen?l="full":r="fit",(typeof e.sizeName>"u"||typeof e.sizeName!="string"||e.sizeName.length===0)&&(e.sizeName=`${e.width}x${e.height}`),i=i.replace(/{url}/g,t),i=i.replace(/{stub}/g,s),i=i.replace(/{width}/g,e.width),i=i.replace(/{height}/g,e.height),i=i.replace(/{quality}/g,e.quality),i=i.replace(/{full}/g,r),i=i.replace(/{fit}/g,l),i=i.replace(/{size}/g,e.sizeName),i}},v=ie;var ne=D.dirname(oe(import.meta.url)),W=se.readJsonSync(D.resolve(ne,"../package.json")),x=new te;x.version(W.version).description(W.description).option("-b, --base <string>","The base URL value. If set then the URL will be appended to this value.").option("-c, --config <string>","The name of the JSON config file to use to get the screenshots. If this is set all other arguments are ignored.").option("-D, --delay <integer>",`The number of milliseconds to delay after loading before taking a picture of the page. Can not be greater than ${w}.`).option("-d, --dir <string>","The directory relative to where the script is run to output the screenshots to.").option("-f, --fit","Fit the screenshot to the provided height and width.").option("-h, --height <integer>",'Integer height of the viewport to take the screenshot in. Use "--fit" if you want the screenshot to only capture the viewport width and height.',"900").option("--jpg",'Set the image type for screenshots to be "jpg". Alternate method to using --type.').option("-n, --name <string>","The name of the file to save the screenshot as. Only applies to the first URL.").option("--png",'Set the image type for screenshots to be "png". Alternate method to using -t.').option("-q, --quality <integer>","The quality of the jpg image, between 0-100. Not applicable to png image.","100").option("-s, --size <string...>",'A viewport size to capture the screenshot in. The format is WIDTHxHEIGHT. For example, 800x400 for a width of 800px and a height of 400px. Use "--fit" if you want the screenshot to only capture the viewport width and height.',[]).option("-t, --type <string>",'The file type to use for the screenshots. "jpg" or "png"',"jpg").option("-u, --url <string...>","URL to get the screenshot of.",[]).option("-w, --width <integer>","Integer width of the viewport to take the screenshot in.","1300").option("--clipH <integer>","The height of clip area.").option("--clipW <integer>","The width of clip area.").option("--clipX <integer>","The x-coordinate of top-left corner of clip area.").option("--clipY <integer>","The y-coordinate of top-left corner of clip area.").action(e=>{let i=new S;i.setProcessConfigFile(),i.parse(e),i.hasUrls()?v.run(i.getConfig()).then(()=>{p("All screenshots have been taken.")}).catch(t=>{g("Error getting screenshots: ",t)}):g("No URLs were provided to get screenshots of. Nothing to do.")});x.addHelpText("after",`
  Examples:
    page-shots -d images -u https://www.mysite.com
    page-shots -u https://www.mysite.com -u https://www.mysite.com/page
    page-shots -d images -u https://www.mysite.com -w 900
    page-shots -d images -u https://www.mysite.com -w 900 -q 80
    page-shots -d images -u https://www.mysite.com -w 900 -t png
    page-shots -d images -u https://www.mysite.com -w 450 -h 800 --fit
    page-shots init
    page-shots
    page-shots -c myurls.json
`);x.command("init [file]").description("Initialize the JSON file that is used to configure the URLs to get screenshots of.").action(e=>{P.setDir(process.cwd()),e&&P.setFilename(e),P.build()});x.parse();
